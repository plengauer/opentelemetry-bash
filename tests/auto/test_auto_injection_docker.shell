if ! type docker; then exit 0; fi
export OTEL_SHELL_EXPERIMENTAL_INJECT_CONTAINERS=TRUE

. ./assert.sh
. /usr/bin/opentelemetry_shell.sh

assert_equals "hello world 0" "$(sudo docker run debian:latest echo hello world 0)"
span="$(resolve_span '.name == "echo hello world 0"')"
assert_equals "SpanKind.INTERNAL" "$(\echo "$span" | \jq -r '.kind')"

assert_equals "hello world 1" "$(sudo docker run ubuntu:latest echo hello world 1)"
span="$(resolve_span '.name == "echo hello world 1"')"
assert_equals "SpanKind.INTERNAL" "$(\echo "$span" | \jq -r '.kind')"

assert_equals "hello world 2" "$(sudo docker run python:latest python3 -c 'print("hello world 2")')"
span="$(resolve_span '.name | startswith("python3 -c ")')"
assert_equals "SpanKind.INTERNAL" "$(\echo "$span" | \jq -r '.kind')"

# node execs, need to improve exec first
# assert_equals "hello world 3" "$(sudo docker run node:latest node -e 'console.log("hello world 3")')"
# span="$(resolve_span '.name | startswith("node -e ")')"
# assert_equals "SpanKind.INTERNAL" "$(\echo "$span" | \jq -r '.kind')"

assert_equals "hello world 0" "$(sudo docker run --entrypoint echo debian:latest hello world 4)"
span="$(resolve_span '.name == "echo hello world 4"')"
assert_equals "SpanKind.INTERNAL" "$(\echo "$span" | \jq -r '.kind')"
