# renovate is really a docker running an npm package, that is pre-isntrumented with otel running in a docker container that during startup runs through an exec and a shebang first!
if ! [ -x "$(which docker)" ]; then exit 0; fi
. ./assert.sh
. /usr/bin/opentelemetry_shell.sh
export OTEL_SHELL_EXPERIMENTAL_INJECT_DEEP=TRUE

log_file="$(\mktemp)"
docker run --rm --env RENOVATE_DRY_RUN=full --env RENOVATE_TOKEN=abc"$ACTIONS_GITHUB_TOKEN" --env RENOVATE_REPOSITORIES="plengauer/opentelemetry-bash" renovate/renovate 2> "$log_file"
\cat "$log_file"
\cat "$OTEL_EXPORT_LOCATION"

assert_not_equals 0 "$?" # because no github token available
span="$(resolve_span '. | select(.name == "/bin/bash /usr/local/bin/node /usr/local/renovate/dist/renovate.js")')"
assert_equals "SpanKind.INTERNAL" $(\echo "$span" | \jq -r '.kind')
span_id="$(\echo "$span" | \jq -r '.context.span_id')"

\cat "$log_file" | \grep parentId
\cat "$log_file" | \grep parentId | \grep "$span_id"
