# renovate is really a docker running an npm package, that is pre-isntrumented with otel running in a docker container that during startup runs through an exec and a shebang first!
if ! [ -x "$(which docker)" ]; then exit 0; fi
. ./assert.sh
export OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE
. /usr/bin/opentelemetry_shell.sh

log_file="$(\mktemp)"
docker run --rm --env RENOVATE_DRY_RUN=full --env RENOVATE_TOKEN=abc --env RENOVATE_REPOSITORIES="plengauer/opentelemetry-bash" ghcr.io/renovatebot/renovate:latest > "$log_file"
assert_not_equals 0 "$?" # because no github token available
\cat "$log_file"
span="$(resolve_span '. | select(.name == "node --use-openssl-ca /usr/local/renovate/dist/renovate.js")')"
assert_equals "SpanKind.INTERNAL" $(\echo "$span" | \jq -r '.kind')
span_id="$(\echo "$span" | \jq -r '.context.span_id')"

\cat "$log_file" | \grep parentId | \grep "${span_id:2}" || exit 1

\cat $OTEL_EXPORT_LOCATION
\docker run --entrypoint /bin/cat --rm ghcr.io/renovatebot/renovate:latest /usr/local/sbin/renovate
